{"ast":null,"code":"import fetchJwks from '../runtime/fetch_jwks.js';\nimport { isCloudflareWorkers } from '../runtime/env.js';\nimport { JWKSInvalid, JWKSNoMatchingKey } from '../util/errors.js';\nimport { isJWKSLike, LocalJWKSet } from './local.js';\nclass RemoteJWKSet extends LocalJWKSet {\n  constructor(url, options) {\n    super({\n      keys: []\n    });\n    this._jwks = undefined;\n    if (!(url instanceof URL)) {\n      throw new TypeError('url must be an instance of URL');\n    }\n    this._url = new URL(url.href);\n    this._options = {\n      agent: options === null || options === void 0 ? void 0 : options.agent,\n      headers: options === null || options === void 0 ? void 0 : options.headers\n    };\n    this._timeoutDuration = typeof (options === null || options === void 0 ? void 0 : options.timeoutDuration) === 'number' ? options === null || options === void 0 ? void 0 : options.timeoutDuration : 5000;\n    this._cooldownDuration = typeof (options === null || options === void 0 ? void 0 : options.cooldownDuration) === 'number' ? options === null || options === void 0 ? void 0 : options.cooldownDuration : 30000;\n    this._cacheMaxAge = typeof (options === null || options === void 0 ? void 0 : options.cacheMaxAge) === 'number' ? options === null || options === void 0 ? void 0 : options.cacheMaxAge : 600000;\n  }\n  coolingDown() {\n    return typeof this._jwksTimestamp === 'number' ? Date.now() < this._jwksTimestamp + this._cooldownDuration : false;\n  }\n  fresh() {\n    return typeof this._jwksTimestamp === 'number' ? Date.now() < this._jwksTimestamp + this._cacheMaxAge : false;\n  }\n  async getKey(protectedHeader, token) {\n    if (!this._jwks || !this.fresh()) {\n      await this.reload();\n    }\n    try {\n      return await super.getKey(protectedHeader, token);\n    } catch (err) {\n      if (err instanceof JWKSNoMatchingKey) {\n        if (this.coolingDown() === false) {\n          await this.reload();\n          return super.getKey(protectedHeader, token);\n        }\n      }\n      throw err;\n    }\n  }\n  async reload() {\n    if (this._pendingFetch && isCloudflareWorkers()) {\n      return new Promise(resolve => {\n        const isDone = () => {\n          if (this._pendingFetch === undefined) {\n            resolve();\n          } else {\n            setTimeout(isDone, 5);\n          }\n        };\n        isDone();\n      });\n    }\n    if (!this._pendingFetch) {\n      this._pendingFetch = fetchJwks(this._url, this._timeoutDuration, this._options).then(json => {\n        if (!isJWKSLike(json)) {\n          throw new JWKSInvalid('JSON Web Key Set malformed');\n        }\n        this._jwks = {\n          keys: json.keys\n        };\n        this._jwksTimestamp = Date.now();\n        this._pendingFetch = undefined;\n      }).catch(err => {\n        this._pendingFetch = undefined;\n        throw err;\n      });\n    }\n    await this._pendingFetch;\n  }\n}\nexport function createRemoteJWKSet(url, options) {\n  return RemoteJWKSet.prototype.getKey.bind(new RemoteJWKSet(url, options));\n}","map":{"version":3,"names":["fetchJwks","isCloudflareWorkers","JWKSInvalid","JWKSNoMatchingKey","isJWKSLike","LocalJWKSet","RemoteJWKSet","constructor","url","options","keys","_jwks","undefined","URL","TypeError","_url","href","_options","agent","headers","_timeoutDuration","timeoutDuration","_cooldownDuration","cooldownDuration","_cacheMaxAge","cacheMaxAge","coolingDown","_jwksTimestamp","Date","now","fresh","getKey","protectedHeader","token","reload","err","_pendingFetch","Promise","resolve","isDone","setTimeout","then","json","catch","createRemoteJWKSet","prototype","bind"],"sources":["/Users/shepher/Downloads/filename-space/node_modules/jose/dist/browser/jwks/remote.js"],"sourcesContent":["import fetchJwks from '../runtime/fetch_jwks.js';\nimport { isCloudflareWorkers } from '../runtime/env.js';\nimport { JWKSInvalid, JWKSNoMatchingKey } from '../util/errors.js';\nimport { isJWKSLike, LocalJWKSet } from './local.js';\nclass RemoteJWKSet extends LocalJWKSet {\n    constructor(url, options) {\n        super({ keys: [] });\n        this._jwks = undefined;\n        if (!(url instanceof URL)) {\n            throw new TypeError('url must be an instance of URL');\n        }\n        this._url = new URL(url.href);\n        this._options = { agent: options === null || options === void 0 ? void 0 : options.agent, headers: options === null || options === void 0 ? void 0 : options.headers };\n        this._timeoutDuration =\n            typeof (options === null || options === void 0 ? void 0 : options.timeoutDuration) === 'number' ? options === null || options === void 0 ? void 0 : options.timeoutDuration : 5000;\n        this._cooldownDuration =\n            typeof (options === null || options === void 0 ? void 0 : options.cooldownDuration) === 'number' ? options === null || options === void 0 ? void 0 : options.cooldownDuration : 30000;\n        this._cacheMaxAge = typeof (options === null || options === void 0 ? void 0 : options.cacheMaxAge) === 'number' ? options === null || options === void 0 ? void 0 : options.cacheMaxAge : 600000;\n    }\n    coolingDown() {\n        return typeof this._jwksTimestamp === 'number'\n            ? Date.now() < this._jwksTimestamp + this._cooldownDuration\n            : false;\n    }\n    fresh() {\n        return typeof this._jwksTimestamp === 'number'\n            ? Date.now() < this._jwksTimestamp + this._cacheMaxAge\n            : false;\n    }\n    async getKey(protectedHeader, token) {\n        if (!this._jwks || !this.fresh()) {\n            await this.reload();\n        }\n        try {\n            return await super.getKey(protectedHeader, token);\n        }\n        catch (err) {\n            if (err instanceof JWKSNoMatchingKey) {\n                if (this.coolingDown() === false) {\n                    await this.reload();\n                    return super.getKey(protectedHeader, token);\n                }\n            }\n            throw err;\n        }\n    }\n    async reload() {\n        if (this._pendingFetch && isCloudflareWorkers()) {\n            return new Promise((resolve) => {\n                const isDone = () => {\n                    if (this._pendingFetch === undefined) {\n                        resolve();\n                    }\n                    else {\n                        setTimeout(isDone, 5);\n                    }\n                };\n                isDone();\n            });\n        }\n        if (!this._pendingFetch) {\n            this._pendingFetch = fetchJwks(this._url, this._timeoutDuration, this._options)\n                .then((json) => {\n                if (!isJWKSLike(json)) {\n                    throw new JWKSInvalid('JSON Web Key Set malformed');\n                }\n                this._jwks = { keys: json.keys };\n                this._jwksTimestamp = Date.now();\n                this._pendingFetch = undefined;\n            })\n                .catch((err) => {\n                this._pendingFetch = undefined;\n                throw err;\n            });\n        }\n        await this._pendingFetch;\n    }\n}\nexport function createRemoteJWKSet(url, options) {\n    return RemoteJWKSet.prototype.getKey.bind(new RemoteJWKSet(url, options));\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}